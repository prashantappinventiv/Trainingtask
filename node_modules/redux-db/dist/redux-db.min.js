var __assign=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++){t=arguments[r];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])}return e},__extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(t,r){function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();define("constants",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TYPE_PK="PK",t.TYPE_ATTR="ATTR",t.TYPE_MODIFIED="MODIFIED"}),define("def",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("utils",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(e){return e?Array.isArray(e)?e:"object"==typeof e?Object.keys(e).map(function(t){return e[t]}):[]:[]},t.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},t.ensureParam=function(e,t){if(void 0===t)throw new Error('Missing a valid value for the argument "'+e+'"');return t},t.ensureParamString=function(e,t){if(void 0===t||null===t||"string"!=typeof t||0===t.length)throw new Error('Missing a valid string for the argument "'+e+'"');return t},t.ensureID=function(e){if(!t.isValidID(e))throw new Error('The given value is not a valid "id". An "id" must be a non-empty string or a number.');return t.asID(e)},t.isValidID=function(e){return null!==e&&void 0!==e&&("string"==typeof e&&e.length>0||"number"==typeof e)},t.asID=function(e){return"string"==typeof e?e:e.toString()},t.toObject=function(e,t){return e.reduce(function(e,r){return e[t(r)]=r,e},{})},t.mergeIds=function(e,t,r){var n,i={};for(n=0;n<e.length;n++)i[e[n]]=!0;for(n=0;n<t.length;n++){if(r&&i[t[n]])throw new Error('Id merge operation violates unique constraint for id: "'+t[n]+'"');i[t[n]]=!0}return Object.keys(i)},t.isEqual=function(e,t){if(e===t)return!0;var n=Object.keys(e),i=Object.keys(t),a=n.length;if(i.length!==a)return!1;for(var o=0;o<a;o++){var s=n[o];if(!(Array.isArray(e[s])&&Array.isArray(t[s])&&r(e[s],t[s]))&&e[s]!==t[s])return!1}return!0};var r=function(e,t){if(e===t)return!0;var r=e.length;if(t.length!==r)return!1;for(var n=0;n<r;n++)if(e[n]!==t[n])return!1;return!0}}),define("models",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.output={},this.emits={},this.schema=e,this.db=e.db,this.normalizePKs=t}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.DbNormalizeContext=n;var i=function(){function e(e,t,n){void 0===n&&(n={ids:[],byId:{},indexes:{}}),this.dirty=!1,this.session=r.ensureParam("session",e),this.schema=r.ensureParam("schema",t),this.state=r.ensureParam("state",n);var i=this.state,a=i.ids,o=i.byId,s=i.indexes;if(!a||!o||!s)throw new Error('The table "'+this.schema.name+'" has an invalid state: '+n);this.state.name||(this.state.name=t.name)}return e.prototype.all=function(){var e=this;return this.state.ids.map(function(t){return e.schema.db.factory.newRecordModel(t,e)})},Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),e.prototype.getValues=function(){var e=this;return this.state.ids.map(function(t){return e.state.byId[t]})},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.map=function(e){return this.all().map(e)},e.prototype.index=function(e,t){return r.ensureParamString("value",e),r.ensureParamString("fk",t),this.state.indexes[e]&&this.state.indexes[e].values[t]?this.state.indexes[e].values[t]:[]},e.prototype.get=function(e){if(!this.exists(e))throw new Error('No "'+this.schema.name+'" record with id: '+e+" exists.");return this.schema.db.factory.newRecordModel(r.asID(e),this)},e.prototype.getOrDefault=function(e){return this.exists(e)?this.get(e):null},e.prototype.getByFk=function(e,t){r.ensureParam("fieldName",e),t=r.ensureID(t);var n=this.schema.fields.filter(function(t){return t.isForeignKey&&t.name===e})[0];if(!n)throw new Error("No foreign key named: "+e+' in the schema: "'+this.schema.name+'".');return new s(this,n,{id:t})},e.prototype.getFieldValue=function(e,t){var r=this.getOrDefault(e);return r?r.value[t]:void 0},e.prototype.getValue=function(e){return r.isValidID(e)?this.state.byId[e]:void 0},e.prototype.exists=function(e){return!!r.isValidID(e)&&void 0!==this.state.byId[r.asID(e)]},e.prototype.insert=function(e){return this.insertMany(e)[0]},e.prototype.insertMany=function(e){return this._normalizedAction(e,this.insertNormalized,!0)},e.prototype.update=function(e){return this.updateMany(e)[0]},e.prototype.updateMany=function(e){return this._normalizedAction(e,this.updateNormalized,!1)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)[0]},e.prototype.upsertRaw=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)},e.prototype.delete=function(e){if("string"!=typeof e&&"number"!=typeof e&&(e=this.schema.getPrimaryKey(e)),!this.exists(e))return!1;e=r.asID(e),this._deleteCascade(e);var t=__assign({},this.state.byId),n=this.state.ids.slice(),i=__assign({},this.state.indexes),a=t[e];delete t[e];var o=n.indexOf(e);return o>=0&&n.splice(o,1),a&&this._cleanIndexes(e,a,i),this.dirty=!0,this.state=__assign({},this.state,{byId:t,ids:n,indexes:i}),!0},e.prototype.deleteAll=function(){this.length&&this.all().forEach(function(e){return e.delete()})},e.prototype.insertNormalized=function(e){var t=this;return r.ensureParam("table",e),this.dirty=!0,this.state=__assign({},this.state,{ids:r.mergeIds(this.state.ids,e.ids,!0),byId:__assign({},this.state.byId,e.byId)}),this._updateIndexes(e),e.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},e.prototype.updateNormalized=function(e){var t=this;r.ensureParam("table",e);var n=__assign({},this.state),i=!1,a=Object.keys(e.byId).map(function(r){if(!t.state.byId[r])throw new Error('Failed to apply update. No "'+t.schema.name+'" record with id: '+r+" exists.");var a=n.byId[r],o=__assign({},a,e.byId[r]);return t.schema.isModified(a,o)&&(n.byId[r]=o,i=!0),t.schema.db.factory.newRecordModel(r,t)});return i&&(this.dirty=!0,this.state=n,this._updateIndexes(e)),a},e.prototype.upsertNormalized=function(e){var t=this;r.ensureParam("table",e);var n={ids:[],byId:{},indexes:{}},i={ids:[],byId:{},indexes:{}};e.ids.forEach(function(r){t.exists(r)?(n.ids.push(r),n.byId[r]=e.byId[r]):(i.ids.push(r),i.byId[r]=e.byId[r])});var a=(n.ids.length?this.updateNormalized(n):[]).concat(i.ids.length?this.insertNormalized(i):[]);return this._updateIndexes(e),a},e.prototype._normalizedAction=function(e,t,i){r.ensureParam("data",e),r.ensureParam("action",t);var a=new n(this.schema,i);this.schema.normalize(e,a);var o=a.output[this.schema.name],s=o?t.call(this,o):[];return this.session.upsert(a),s},e.prototype._updateIndexes=function(e){var t=this;Object.keys(e.indexes).forEach(function(n){var i=t.state.indexes[n]||(t.state.indexes[n]={unique:e.indexes[n].unique,values:{}});Object.keys(e.indexes[n].values).forEach(function(a){var o=i.values[a]||(i.values[a]=[]),s=r.mergeIds(o,e.indexes[n].values[a],!1);if(i.unique&&s.length>1)throw new Error('The insert/update operation violates the unique foreign key "'+t.schema.name+"."+n+'".');i.values[a]=s})})},e.prototype._cleanIndexes=function(e,t,r){this.schema.getForeignKeys(t).forEach(function(t){var n=-1;if(t.value&&r[t.name]&&r[t.name].values[t.value]&&(n=r[t.name].values[t.value].indexOf(e)),n>=0){var i=r[t.name].values[t.value].slice();i.splice(n,1),r[t.name].values[t.value]=i}else r[t.name]&&(delete r[t.name].values[e],0===Object.keys(r[t.name].values).length&&delete r[t.name])})},e.prototype._deleteCascade=function(e){var t=this.schema.relations.filter(function(e){return e.relationName&&e.cascade});if(t.length){var r=this.get(e);r&&t.forEach(function(e){var t=r[e.relationName];t&&t.delete()})}},e}();t.TableModel=i;var a=function(){function e(e,t){this.id=r.ensureParam("id",e),this.table=r.ensureParam("table",t)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.getValue(this.id)||{}},set:function(e){this.update(e)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.schema.injectKeys(e,this),this.table.update(e),this},e}();t.RecordModel=a;var o=function(){function e(e,t){this.schema=r.ensureParam("schema",e),this.record=r.ensureParam("record",t),this.name=r.ensureParamString("schema.name",e.name)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.RecordFieldModel=o;var s=function(){function e(e,t,n){this.table=r.ensureParam("table",e),this.schema=r.ensureParam("schema",t),this.owner=r.ensureParam("owner",n)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.map(function(e){return e.value})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.index(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var e=this;return this.ids.map(function(t){return e.table.schema.db.factory.newRecordModel(t,e.table)})},e.prototype.map=function(e){return this.all().map(e)},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.add=function(e){this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var t=this;this._normalize(e).forEach(function(e){var r=t.table.schema.getPrimaryKey(e);t.table.delete(r)})},e.prototype.update=function(e){return this.table.update(this._normalize(e)),this},e.prototype.delete=function(){var e=this;this.ids.forEach(function(t){return e.table.delete(t)})},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.RecordSetModel=s}),define("schema",["require","exports","utils","constants"],function(e,t,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,i){var o=this;this._relations=[],this.db=r.ensureParam("db",e),this.name=r.ensureParamString("name",t),this.fields=Object.keys(r.ensureParam("schema",i)).map(function(t){return new a(o,t,i[t],!0===e.options.cascadeAsDefault)}),this._primaryKeyFields=this.fields.filter(function(e){return e.isPrimaryKey}),this._foreignKeyFields=this.fields.filter(function(e){return e.isForeignKey}),this._stampFields=this.fields.filter(function(e){return e.type===n.TYPE_MODIFIED})}return Object.defineProperty(e.prototype,"relations",{get:function(){return this._relations},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){var t=this;e.forEach(function(e){return t._relations=t._relations.concat(e.fields.filter(function(e){return e.references===t.name}))}),this._foreignKeyFields.forEach(function(t){return t.connect(e)})},e.prototype.normalize=function(e,t){var n=this;if("object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var i=r.ensureParam("context",t);return i.output[this.name]||(i.output[this.name]={ids:[],byId:{},indexes:{}}),r.ensureArray(e).map(function(e){if("object"!=typeof e)throw new Error("Failed to normalize data. Given record is not a plain object.");var t=n.db.normalizeHooks?n.db.normalizeHooks[n.name]:null;t&&(e=t(e,i));var a=i.normalizePKs?n._normalizePrimaryKey(e):n._getPrimaryKey(e);if(!a)throw new Error('Failed to normalize primary key for record of type "'+n.name+'". Make sure record(s) have a primary key value before trying to insert or update a table.');var o=n.getForeignKeys(e),s=i.output[n.name];s.byId[a]||s.ids.push(a);var u=s.byId[a]=__assign({},e);o.forEach(function(e){if("object"==typeof e.value&&e.refTable){var t=e.refTable.normalize(e.value,i);if(t.length>1)throw new Error('Invalid schema definition. The field "'+n.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');u[e.name]=e.value=t[0]}if(r.isValidID(e.value)){var o=r.asID(e.value),l=s.indexes[e.name]||(s.indexes[e.name]={unique:e.unique,values:{}});if(l.values[o]||(l.values[o]=[]),l.unique&&l.values.length)throw new Error('The insert/update operation violates the unique foreign key "'+n.name+"."+e.name+'".');l.values[o].push(a)}});return n.relations.forEach(function(e){if(e.relationName&&u[e.relationName]){var t=n.inferRelations(u[e.relationName],e,a);e.table.normalize(t,i),delete u[e.relationName]}}),a})},e.prototype.inferRelations=function(e,t,n){if(!t.relationName)return e;var i=t.table.fields.filter(function(e){return e.isForeignKey&&e!==t});return r.ensureArray(e).map(function(e){return"number"!=typeof e&&"string"!=typeof e||(1===i.length?((r={})[i[0].name]=e,e=r):e={id:e}),__assign({},e,(a={},a[t.name]=n,a));var r,a})},e.prototype.injectKeys=function(e,t){if(!e||"object"!=typeof e)return e;var r=this._primaryKeyFields;r.length||(r=this._foreignKeyFields),r.forEach(function(r){void 0===e[r.name]&&(e[r.name]=r.getRecordValue(t))})},e.prototype.getPrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return t},e.prototype._getPrimaryKey=function(e){var t=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(t,r){var n=r.getValue(e);return t&&n?t+"_"+n:n},null);return r.isValidID(t)&&r.asID(t)},e.prototype._normalizePrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t&&this.db.onMissingPk){var r=this.db.onMissingPk(e,this);r&&(1===this._primaryKeyFields.length&&(e[this._primaryKeyFields[0].propName]=r),t=r)}return t},e.prototype.getForeignKeys=function(e){return this._foreignKeyFields.map(function(t){return{name:t.name,value:e[t.name],refTable:t.refTable,unique:t.unique,notNull:t.notNull}})},e.prototype.isModified=function(e,t){return this._stampFields.length>0?this._stampFields.reduce(function(r,n){return r+(n.getValue(e)===n.getValue(t)?1:0)},0)!==this._stampFields.length:!r.isEqual(e,t)},e}();t.TableSchemaModel=i;var a=function(){function e(e,t,i,a){this.table=r.ensureParam("table",e),this.type=i.type||n.TYPE_ATTR,this.name=t,this.propName=i.propName||t,this._valueFactory=i.value?i.value.bind(this):null,this.isPrimaryKey=i.type===n.TYPE_PK,this.isForeignKey=null!==i.references&&void 0!==i.references,this.isPrimaryKey||this.isForeignKey?(this.references=i.references,this.relationName=i.relationName,this.cascade=void 0===i.cascade?a:!0===i.cascade,this.unique=!0===i.unique,this.notNull=void 0===i.notNull||!0===i.notNull):(this.cascade=!1,this.unique=!1,this.notNull=!0===i.notNull)}return Object.defineProperty(e.prototype,"refTable",{get:function(){return this._refTable},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){var t=this;if(this.references&&(this._refTable=e.filter(function(e){return e.name===t.references})[0],!this._refTable))throw new Error('The field schema "'+this.table.name+"."+this.name+'" has an invalid reference to unknown table "'+this.references+'".')},e.prototype.getValue=function(e,t){return this._valueFactory?this._valueFactory(e,{schema:this,record:t}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.FieldSchemaModel=a}),define("factory",["require","exports","models","schema"],function(e,t,r,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(e){return function(e){function t(t,r){var n=e.call(this,t,r)||this;return n.__fields={},n}return __extends(t,e),t}(e)},a=function(){function e(){this._recordClass={}}return e.prototype.newTableSchema=function(e,t,r){return new n.TableSchemaModel(e,t,r)},e.prototype.newTableModel=function(e,t,n){return new r.TableModel(e,t,n)},e.prototype.newRecordModel=function(e,t){return new(this._createRecordModel(t.schema))(e,t)},e.prototype.newRecordField=function(e,t){if(!e.isForeignKey)return new r.RecordFieldModel(e,t);var n=e.references&&t.table.session.tables[e.references];if(!n)throw new Error('The foreign key: "'+e.name+'" references an unregistered table: "'+e.references+'" in the current session.');var i=e.getRecordValue(t);return void 0===i?null:n.getOrDefault(i)},e.prototype.newRecordSet=function(e,t){var n=t.table.session.tables[e.table.name];if(!n)throw new Error('The table: "'+e.table.name+'" does not exist in the current session.');return new r.RecordSetModel(n,e,t)},e.prototype.newRecordRelation=function(e,t){var r=t.table.session.tables[e.table.name];if(!r)throw new Error('The table: "'+e.table.name+'" does not exist in the current session.');var n=r.index(e.name,t.id)[0];return void 0===n?null:this.newRecordModel(n,r)},e.prototype.getRecordBaseClass=function(e){return r.RecordModel},e.prototype._createRecordModel=function(e){var t=this;if(this._recordClass[e.name])return this._recordClass[e.name];var r=i(this.getRecordBaseClass(e)),n=function(e,t,n,i){if(void 0===i&&(i=!0),"id"===e)throw new Error('The property "'+t.table.name+'.id" is a reserved name. Please specify another name using the "propName" definition.');Object.defineProperty(r.prototype,e,{get:function(){return i?this.__fields[e]||(this.__fields[e]=n(t,this)):n(t,this)}})};return e.fields.forEach(function(e){return(e.isForeignKey||!e.isPrimaryKey)&&n(e.propName,e,t.newRecordField.bind(t),!1)}),e.relations.forEach(function(e){return e.relationName&&n(e.relationName,e,e.unique?t.newRecordRelation.bind(t):t.newRecordSet.bind(t),!e.unique)}),this._recordClass[e.name]=r},e}();t.DefaultModelFactory=a}),define("index",["require","exports","utils","factory","models"],function(e,t,r,n,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultModelFactory=n.DefaultModelFactory,function(e){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}(i);var a={cascadeAsDefault:!1};t.createDatabase=function(e,t){return new o(e,t)};var o=function(){function e(e,t){var i=this;r.ensureParam("schema",e),this.options=__assign({},a,t),this.normalizeHooks=this.options.onNormalize||{},this.factory=this.options.factory||new n.DefaultModelFactory,this.onMissingPk=this.options.onMissingPk||void 0,this.tables=Object.keys(e).map(function(t){return i.factory.newTableSchema(i,t,e[t])}),this.tables.forEach(function(e){return e.connect(i.tables)})}return e.prototype.combineReducers=function(){for(var e=this,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];return function(r,n){return void 0===r&&(r={}),e.reduce(r,n,t)}},e.prototype.reduce=function(e,t,n,i){var a=this.createSession(e);return r.ensureArray(n).forEach(function(e){return e(a.tables,t,i)}),a.commit()},e.prototype.createSession=function(e,t){return new s(e,this,__assign({readOnly:!1},t))},e.prototype.selectTables=function(e){var t=this,r=Object.keys(e).map(function(e){var r=t.tables.filter(function(t){return t.name===e})[0];if(!r)throw new Error('Could not select table. The table "'+e+'" is not defined in schema.');return r});return s.Partial(e,r,this)},e.prototype.selectTable=function(e,t){var r=t||e.name;if(!r)throw new Error("Failed to select table. Could not identify table schema.");return this.selectTables((n={},n[r]=e,n))[r];var n},e}();t.Database=o;var s=function(){function e(e,t,n){void 0===e&&(e={});var i=this;this.state=e,this.db=t,this.options=n,this.tables=r.toObject(t.tables.map(function(t){return i.db.factory.newTableModel(i,t,e[t.name])}),function(e){return e.schema.name})}return e.prototype.upsert=function(e){var t=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");Object.keys(e.output).forEach(function(r){r!==e.schema.name&&t.tables[r].upsertNormalized(e.output[r])}),Object.keys(e.emits).forEach(function(r){r!==e.schema.name&&t.tables[r].upsert(e.emits[r])})},e.prototype.commit=function(){var e=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");return Object.keys(this.tables).forEach(function(t){var r=e.state[t],n=e.tables[t].state;r!==n&&(e.state=__assign({},e.state,(i={},i[t]=n,i)));var i}),this.state},e.Partial=function(t,r,n){return new e(t,{tables:r,options:n.options,factory:n.factory,normalizeHooks:n.normalizeHooks},{readOnly:!0}).tables},e}();t.DatabaseSession=s});